<!DOCTYPE html>
<html>
  <head>
  <title>license Infomation</title>
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <link rel="stylesheet" href="./css/index.css" type="text/css" />
  <script src="./config/conf.js"></script>
  <script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react@15/dist/react.js"></script>
  <script src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.js"></script>
  <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/html-react-parser@latest/dist/html-react-parser.min.js"></script>
  <script type="text/babel">

  const debounce = (fn, delay) => {
  	var timer = null;
  	return function(){
  		clearTimeout(timer);
  		timer = setTimeout(function(){
  			fn();
  		}, delay);
  	};
  }

  if(localStorage){
    window.addEventListener('scroll', debounce(handleScroll, 500));
    if(localStorage.getItem("scrollTop") > 0){
      $('html, body').animate({scrollTop :localStorage.getItem("scrollTop")}, 400);
    }
  }

  function handleScroll(){
    setLocalStorage(window.scrollY);
  }
  function setLocalStorage(scrollTop){
    localStorage.setItem("scrollTop", scrollTop);
  }

  var arr = [];
  if(localStorage){
    if(!(localStorage.getItem("no") == null || localStorage.getItem("no") == "")){
      arr = localStorage.getItem("no").split(',');

    }
  }
  function localStorageRemoveNo(no){
    if(localStorage){
      let getNo = localStorage.getItem("no");
      let temp=null;
      if(getNo != null){
        temp = getNo;
        temp = temp.split(',');
        temp.splice(temp.indexOf(no), 1);
        arr = temp.filter((item, idx, array)=>{
          return array.indexOf( item ) === idx ;
        });
        temp = arr.join(',');
        localStorage.setItem("no",temp);
      }

    }
  }

  function localStorageAddNo(no){
    if(localStorage){
      let getNo = localStorage.getItem("no");
      let temp=null;
      if(getNo == null || getNo == ""){
        arr.push(no);
        temp = arr.join(',');
        localStorage.setItem("no",temp);
      }else{
        temp = getNo;
        temp = temp.split(',');
        temp.push(no);
        arr = temp.filter((item, idx, array)=>{
          return array.indexOf( item ) === idx ;
        });
        temp = arr.join(',');
        localStorage.setItem("no",temp);
      }
    }
  }
  class Navi extends React.Component{
    constructor(props){
      super(props);
      this.handleClick2 = this.handleClick2.bind(this);
      this.handleClick3 = this.handleClick3.bind(this);
      this.handleClick4 = this.handleClick4.bind(this);
      this.handleClick5 = this.handleClick4.bind(this);
    }

    handleClick2(e){
      e.preventDefault();
      location.href="./algorithm.html";
    }
    handleClick3(e){
      e.preventDefault();
      location.href="./databases.html";
    }
    handleClick4(e){
      e.preventDefault();
      location.href="./eng.html";
    }
    handleClick5(e){
      e.preventDefault();
      location.href="./process.html";
    }

    render(){
      return(
        <div className="navigator">
          <div className="active">신기술동향</div>
          <div onClick={this.handleClick2}>알고리즘</div>
          <div onClick={this.handleClick3}>데이터베이스</div>
          <div onClick={this.handleClick4}>전산영어</div>
          <div onClick={this.handleClick5}>업무프로세스</div>
        </div>
      );
    }
  }

  class NewTechnologyInfo extends React.Component{
	constructor(props){
		super(props);
    this.state = {
      answer: 0,
	  inputValue: '',
	  showAnswer: 0
    }

    this.handleCLick=this.handleCLick.bind(this);
    this.handleChangeAnswer = this.handleChangeAnswer.bind(this);
	this.handleShowAnswerClick = this.handleShowAnswerClick.bind(this);
	}

 handleShowAnswerClick(){
	if(this.state.showAnswer == 0){
		this.setState({
			showAnswer: 1
		})
	}else{
		this.setState({
			showAnswer: 0
		})
	}
 }

  handleCLick(e){
    if(e.target.classList.contains("active")){
      //초기화
      localStorageRemoveNo(e.target.innerText);
      e.target.classList.remove("active");
    }else{
      //입력
      localStorageAddNo(e.target.innerText);
      e.target.classList.add("active");
    }
  }

  handleChangeAnswer(e){
	this.setState({
		inputValue: e.target.value
	})
    if(e.target.value != ""){
      if(
        this.props.content.en.toLowerCase().replace(new RegExp("\\s","gi"),"") == e.target.value.toLowerCase().replace(new RegExp("\\s","gi"),"") ||
        this.props.content.full_en.toLowerCase().replace(new RegExp("\\s","gi"),"") == e.target.value.toLowerCase().replace(new RegExp("\\s","gi"),"") ||
        this.props.content.ko.toLowerCase().replace(new RegExp("\\s","gi"),"") == e.target.value.toLowerCase().replace(new RegExp("\\s","gi"),"")
      ){
        this.setState({
          answer: 1
        })
      }else{
        this.setState({
          answer: 0
        })
      }
    }
  }
  	render(){
      let eng_txt = "";
      if(this.props.content.en){
        eng_txt += "<span>영문: <b>"+this.props.content.en+"</b></span>"
      }
      if(this.props.content.full_en){
        eng_txt += "<span>풀네임: <b>"+this.props.content.full_en+"</b></span>"
      }

      let activeClass="";
      let tempStr = this.props.content.no+"";
      if(arr.indexOf(tempStr) !== -1){
        activeClass = "active";
      }

      let heightStyle={}
      if(this.props.mode == "normal"){
        heightStyle={
          height:"0"
        }
      }else{
        heightStyle={
          height:"auto"
        }
      }

	  let showAnswer="";
	  if(this.props.mode != "normal"){
		if(this.state.showAnswer==0){
			showAnswer="정답보기";
		}else{
			showAnswer=this.props.content.en;
		}
	  }
  		return(
  			<div className="postCard">
          <div className="card-head">
            <span className={'no '+ activeClass} onClick={this.handleCLick}>
              {this.props.content.no}
            </span>
            <div className="card-title">
            {this.props.mode == "normal" ? HTMLReactParser(this.props.content.ko) : ''}
            </div>
            <div className="card-subinfo">
              {this.props.mode == "normal" ? HTMLReactParser(eng_txt) : ''}
            </div>
          </div>
          <div className="card-content">
            {HTMLReactParser(this.props.content.description)}
			<span className="show-answer" onClick={this.handleShowAnswerClick}>
				{showAnswer}
			</span>
          </div>
          <div className="testing-input" style={heightStyle}>
            <span>
              {this.props.mode != "normal" ? '정답은? ' : ''}
            </span>
            {this.props.mode != "normal" ? <input type="text" onChange={this.handleChangeAnswer} value={this.state.inputValue}/> : ''}
            <span>
              {(this.props.mode != "normal") && (this.state.answer==1) ? '정답' : ''}
            </span>
          </div>
        </div>
  		);
  	}
  }

  class NewTechnology extends React.Component{
  	constructor(props){
  		super(props);

  		this.state = {
  			keyword: '',
        newTechnologyData: newTechnologyObject,
        mode: "normal"
  		}
  		this.handleChange = this.handleChange.bind(this);
      this.handleModeChangeClick = this.handleModeChangeClick.bind(this);
    }

  	handleChange(e){
  		this.setState({
  			keyword: e.target.value
  		});
  	}

    handleModeChangeClick(){
      if(this.state.mode == "normal"){
        this.setState({
          mode: "testing"
        });
      }else{
        this.setState({
          mode: "normal"
        });
      }

    }


  	render(){
      const mapToComponents = (data) => {
  			data.sort();
  			﻿
  			data = data.filter(
  				(content) => {
					content.ko = content.ko.replace(/<mark>/gi, "");
					content.ko = content.ko.replace(/<\/mark>/gi, "");
					content.en = content.en.replace(/<mark>/gi, "");
					content.en = content.en.replace(/<\/mark>/gi, "");
					content.full_en = content.full_en.replace(/<mark>/gi, "");
					content.full_en = content.full_en.replace(/<\/mark>/gi, "");
					content.description = content.description.replace(/<mark>/gi, "");
					content.description = content.description.replace(/<\/mark>/gi, "");

  					return (
              (content.ko.toLowerCase().indexOf(this.state.keyword.toLowerCase()) > -1) ||
              (content.en.toLowerCase().indexOf(this.state.keyword.toLowerCase()) > -1) ||
              (content.full_en.toLowerCase().indexOf(this.state.keyword.toLowerCase()) > -1) ||
              (content.description.toLowerCase().indexOf(this.state.keyword.toLowerCase()) > -1) ||
              ("#"+content.no == this.state.keyword)
            );
  				}
  			)

  			return data.map((content, i)=>{
				if(this.state.keyword != ""){
					content.ko = content.ko.replace(new RegExp(this.state.keyword,"gi"), (match) => {return "<mark>"+match+"</mark>"});
					content.en = content.en.replace(new RegExp(this.state.keyword,"gi"), (match) => {return "<mark>"+match+"</mark>"});
					content.full_en = content.full_en.replace(new RegExp(this.state.keyword,"gi"), (match) => {return "<mark>"+match+"</mark>"});
					content.description = content.description.replace(new RegExp(this.state.keyword,"gi"), (match) => {return "<mark>"+match+"</mark>"});
				}
  				return (<NewTechnologyInfo content={content} key={i} mode={this.state.mode}/>);
  			});
  		}
      const relativeBox={
        position:"relative"
      }
  		return(
  			<div>
  				<header>
            <h1>신기술동향 단어장</h1>
          </header>
          <div className="searchBox">
            <span>#번호 or 검색키워드</span>
            <div style={relativeBox}>
              <div className="TstingBox" onClick={this.handleModeChangeClick}>
                {this.state.mode=="normal" ? '문제풀기' : '기본전환'}
              </div>
            </div>
            <input name="keyword" placeholder="Search for Keyword" value={this.state.keyword} onChange={this.handleChange}/>
          </div>

  				<div className="postCardBox">
            {mapToComponents(this.state.newTechnologyData)}
  				</div>
  			</div>
  		);
  	}
  }

  class App extends React.Component {
    constructor(props){
      super(props);
    }
    render() {
    return (
      <div className="app">
        <NewTechnology />
        <Navi />
      </div>
    );
    }
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
  </head>

  <body>
    <div id="root"></div>
  </body>
</html>
